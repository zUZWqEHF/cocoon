name: Build OS Images

on:
  push:
    branches: [master]
    paths:
      - "os-image/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  detect:
    name: Detect changed images
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed Dockerfiles
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # On manual trigger, build everything
            changed=$(find os-image -name Dockerfile -type f)
          else
            BEFORE="${{ github.event.before }}"
            # Handle initial push (before is all zeros)
            if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
              changed=$(find os-image -name Dockerfile -type f)
            else
              changed=$(git diff --name-only "$BEFORE" "${{ github.sha }}" -- 'os-image/' | sort -u)
              # For any changed file under os-image/{name}/, find all Dockerfiles in that name group
              declare -A names
              for f in $changed; do
                # Extract the name part: os-image/{name}/...
                name=$(echo "$f" | cut -d'/' -f2)
                if [[ -n "$name" ]]; then
                  names[$name]=1
                fi
              done

              changed=""
              for name in "${!names[@]}"; do
                found=$(find "os-image/$name" -name Dockerfile -type f)
                changed="$changed"$'\n'"$found"
              done
            fi
          fi

          matrix_entries=()
          while IFS= read -r dockerfile; do
            [[ -z "$dockerfile" ]] && continue
            # Expected: os-image/{name}/{tag}/Dockerfile
            name=$(echo "$dockerfile" | cut -d'/' -f2)
            tag=$(echo "$dockerfile" | cut -d'/' -f3)
            if [[ -n "$name" && -n "$tag" ]]; then
              matrix_entries+=("{\"name\":\"$name\",\"tag\":\"$tag\"}")
            fi
          done <<< "$changed"

          if [[ ${#matrix_entries[@]} -eq 0 ]]; then
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
          else
            json=$(IFS=,; echo "${matrix_entries[*]}")
            echo "matrix={\"include\":[$json]}" >> "$GITHUB_OUTPUT"
          fi

          echo "Generated matrix: $(cat "$GITHUB_OUTPUT")"

  build:
    name: Build ${{ matrix.name }}:${{ matrix.tag }}
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.name }}
          tags: |
            type=raw,value=${{ matrix.tag }}
            type=sha,prefix=${{ matrix.tag }}-

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: os-image/${{ matrix.name }}
          file: os-image/${{ matrix.name }}/${{ matrix.tag }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.name }}-${{ matrix.tag }}
          cache-to: type=gha,mode=max,scope=${{ matrix.name }}-${{ matrix.tag }}
